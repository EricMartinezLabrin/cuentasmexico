{% extends 'index/base/base.html' %}
{% block title %}Carrito{% endblock title %}
{% block body %}
<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'index' %}" class="cm">Inicio</a></li>
      <li class="breadcrumb-item cm"><a href="#" class="cm">Tienda</a></li>
      <li class="breadcrumb-item active cm" aria-current="page">Carrito</li>
    </ol>
  </nav>
<h1>Carrito</h1>
<div class="mb-lg-14 mb-8 mt-8">
    <div class="row">
        <div class="col-lg-8 col-md-7">
            <div class="py-3">
                <ul class="list-group list-group-flush">
                    <!-- list group -->
                    <li class="list-group-item py-3 py-lg-0 px-0 border-top">
                    <!-- row -->
                    {% if request.session.cart_number.items %}
                    {% for key, value in request.session.cart_number.items %}
                        <div class="row align-items-center">
                            <div class="col-3 col-md-2">
                            <!-- img --> {% if value.image %}<img src="{{value.image}}" alt="{{value.name}}" class="img-fluid">{% endif %}</div>
                            <div class="col-4 col-md-5">
                            <!-- title -->
                            <h6 class="mb-0 cm">{{value.name}}</h6>
                            <span><small class="text-muted">{{value.profiles}} Dispositivo{{value.profiles|pluralize}} </small></span>
                            <!-- text -->
                            <div class="mt-2 small lh-1"> <a href="{% url 'removeCart' value.product_id %}" class="text-decoration-none text-inherit"> <span class="me-1 align-text-bottom">
                                <i class="bi bi-trash3 cm"></i></span><span class="text-muted">Remove</span></a></div>
                            </div>
                            <!-- input group -->
                            <div class="col-3 col-md-3 col-lg-3">
                                <!-- input -->
                                <div class="input-group mb-3">
                                    <a href="{% url 'decrementCart' value.product_id value.unitPrice %}" class="btn btn-outline-secondary" id="button-addon1">-</a>
                                    <input type="number" class="form-control no-arrow" id="month" placeholder="{{value.quantity}} me{{value.quantity|pluralize:"s,ses"}}" aria-label="Example text with button addon" aria-describedby="button-addon1" readonly>
                                    <a href="{% url 'addCart' value.product_id value.unitPrice %}" class="btn btn-outline-secondary" id="button-addon1">+</a>
                                </div>
                            </div>
                            <!-- price -->
                            <div class="col-2 text-lg-end text-start text-md-end col-md-2">
                            <span class="fw-bold">${{value.price}}</span>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5">
                            <div class="alert alert-danger" role="alert">
                                No hay productos en el carrito
                            </div> 
                        </td>
                    </tr>
                      {% endif %}
                      <div id="error"></div>
                
            </div>
        </div>
        <div class="col-12 col-lg-4 col-md-5">
            <!-- card -->
            <div class="mb-5 card mt-6">
            <div class="card-body p-6">
                <!-- heading -->
                <h2 class="h5 mb-4">Resumen</h2>
                <div class="card mb-2">
                <!-- list group -->
                <ul class="list-group list-group-flush">
                    <!-- list group item -->
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="me-auto">
                        <div>Subtotal</div>

                    </div>
                    <span>{{request.session.cart_total}}</span>
                    </li>

                    <!-- list group item -->
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="me-auto">
                        <div>Comision</div>

                    </div>
                    <span>$0</span>
                    </li>
                    <!-- list group item -->
                    <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="me-auto">
                        <div class="fw-bold">Total</div>
                    </div>
                    <span class="fw-bold">${{request.session.cart_total}}</span>
                    </li>
                </ul>

                </div>
                <div class="d-grid mb-1 mt-4">
                <!-- btn -->
                {% if request.user.is_authenticated %}
                    {% if request.user.userdetail.level.name == 'Distribuidor' %}
                        <a href="{% url 'checkout_distributor' %}" id="btn-buy" class="btn btn-cm btn-lg d-flex justify-content-between align-items-center" >
                            Comprar <span class="fw-bold">se descontarán {{request.session.cart_total}} Créditos</span>
                        </a>
                    {% else %}
                        <!-- Metodos de pago disponibles -->
                        <div class="mb-3">
                            <h6 class="mb-2">Selecciona tu metodo de pago:</h6>
                        </div>

                        {% if paypal_enabled and paypal_data %}
                        <!-- Boton PayPal -->
                        <div id="paypal-button-container" class="mb-3"></div>
                        <div id="paypal-loading" class="text-center mb-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Procesando...</span>
                            </div>
                            <p class="mt-2">Procesando tu pago con PayPal...</p>
                        </div>
                        {% endif %}

                        {% if stripe_enabled and stripe_data %}
                        <!-- Boton Stripe -->
                        <button id="stripe-checkout-button" class="btn btn-dark btn-lg w-100 d-flex justify-content-between align-items-center mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="25" viewBox="0 0 60 25" fill="none">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M60 12.8C60 8.55 57.85 5.15 53.8 5.15C49.75 5.15 47.15 8.55 47.15 12.75C47.15 17.7 50.15 20.45 54.45 20.45C56.55 20.45 58.15 19.95 59.35 19.25V15.85C58.15 16.5 56.8 16.9 55.1 16.9C53.45 16.9 51.95 16.35 51.75 14.35H59.95C59.95 14.15 60 13.25 60 12.8ZM51.7 11.35C51.7 9.45 52.85 8.55 53.8 8.55C54.7 8.55 55.8 9.45 55.8 11.35H51.7Z" fill="white"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M40.9 5.15C39.2 5.15 38.15 5.95 37.55 6.5L37.35 5.4H33.35V25L37.95 24.05L37.95 19.55C38.55 19.95 39.45 20.5 40.85 20.5C43.75 20.5 46.35 18.15 46.35 12.6C46.35 7.55 43.7 5.15 40.9 5.15ZM39.85 16.75C38.85 16.75 38.25 16.4 37.95 16L37.95 9.65C38.25 9.2 38.9 8.85 39.85 8.85C41.35 8.85 42.35 10.55 42.35 12.8C42.35 15.1 41.35 16.75 39.85 16.75Z" fill="white"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M28.1 4.1L32.7 3.15V0L28.1 0.95V4.1Z" fill="white"/>
                                <path d="M32.7 5.4H28.1V20.2H32.7V5.4Z" fill="white"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M23.55 6.6L23.3 5.4H19.35V20.2H23.95V10.1C25.05 8.7 26.95 8.95 27.5 9.15V5.4C26.9 5.15 24.65 4.8 23.55 6.6Z" fill="white"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M14.45 1.9L10 2.85L9.95 16.15C9.95 18.6 11.8 20.5 14.25 20.5C15.6 20.5 16.55 20.25 17.1 19.95V16.4C16.6 16.6 14.45 17.25 14.45 14.8V9H17.1V5.4H14.45V1.9Z" fill="white"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M4.65 9.65C4.65 9 5.2 8.75 6.1 8.75C7.35 8.75 8.95 9.15 10.2 9.85V5.7C8.85 5.15 7.5 4.95 6.1 4.95C2.45 4.95 0 6.95 0 10C0 14.55 6.3 13.85 6.3 15.8C6.3 16.55 5.6 16.8 4.65 16.8C3.3 16.8 1.5 16.25 0.1 15.45V19.65C1.6 20.3 3.15 20.55 4.65 20.55C8.4 20.55 11 18.6 11 15.5C11 10.6 4.65 11.45 4.65 9.65Z" fill="white"/>
                            </svg>
                            <span>Pagar con Tarjeta</span>
                        </button>
                        <div id="stripe-loading" class="text-center mb-3" style="display: none;">
                            <div class="spinner-border text-dark" role="status">
                                <span class="visually-hidden">Procesando...</span>
                            </div>
                            <p class="mt-2">Redirigiendo a Stripe...</p>
                        </div>
                        {% endif %}

                        {% if mercadopago_enabled and init_point %}
                        <!-- Boton MercadoPago (deshabilitado por defecto) -->
                        <div class="mt-2">
                            <a href="{% url 'start_payment' %}?initpoint={{ init_point }}" id="buy-mp" class="btn btn-outline-secondary btn-lg w-100 d-flex justify-content-between align-items-center">
                                <img src="https://www.mercadopago.com/org-img/MP3/home/logomp3.gif" alt="MercadoPago" style="height: 24px;">
                                <span>Pagar con MercadoPago</span>
                            </a>
                        </div>
                        {% endif %}

                        {% if not paypal_enabled and not mercadopago_enabled and not stripe_enabled %}
                        <button class="btn btn-secondary btn-lg w-100" disabled>
                           No hay metodos de pago disponibles
                        </button>
                        {% endif %}

                        {% if paypal_enabled and not paypal_data and not mercadopago_enabled and stripe_enabled and not stripe_data %}
                        <button class="btn btn-secondary btn-lg w-100" disabled>
                           Agrega productos al carrito
                        </button>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-cm btn-lg d-flex justify-content-between align-items-center">
                        <span class="fw-bold">Inicia sesion para continuar</span>
                    </a>
                {% endif %}
                </div>
                <!-- text -->
                <p><small>Al completar la orden aceptas los <a href="#!">Terminos y Condiciones</a>
                    and <a href="#!">Politica de privacidad</a> de Cuentas México </small></p>

                <!-- heading -->
                <div class="mt-8">
                <h2 class="h5 mb-3">Código de descuento</h2>
                <form>
                    <div class="mb-2">
                    <!-- input -->
                    <label for="giftcard" class="form-label sr-only">Código de descuento</label><br>
                    <small>No válidos cupones de tiendas. Si tienes uno puedes canjearlo <a href="{% url 'redeem' %}">aquí</a></small>
                    <input type="text" class="form-control" id="giftcard" placeholder="Escribe tu código o cupón">

                    </div>
                    <!-- btn -->
                    <div class="d-grid"><button type="submit" class="btn btn-outline-dark mb-1">Canjear</button></div>
                    <p class="text-muted mb-0"> <small>Aplican terminos y codiciones</small></p>
                </form>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

{% comment %} <div class="cho-container">
    <li>
      <label for="radio">Botão open-radio: </label>
      <input type="radio" id="checkout-open-radio" >
    </li>
</div> {% endcomment %}
{% endblock body %}
{% block extrajs %}
<!-- PayPal SDK -->
{% if paypal_enabled and paypal_data %}
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id|default:'sb' }}&currency=MXN&locale=es_MX"></script>
{% endif %}

<script>
    const level = "{{ request.user.userdetail.level.name }}";

    if (level === "Distribuidor") {
        insuficient_credits()
    }

    function insuficient_credits() {
        var credits = {{ credits }};
        var bill = {{ request.session.cart_total }};
        const buy = document.getElementById('buy');
        const error = document.getElementById('error')
        if (credits < bill) {
            console.log('no alcanza')
            buy.className += ' disabled';
            error.innerHTML = `
            <br>
            <tr>
                <td colspan="5">
                    <div class="alert alert-danger" role="alert">
                        No tienes creditos suficientes. Tienes <b>${credits}</b> y necesitas <b>${bill}</b>, para continuar debes recargar.
                    </div>
                </td>
            </tr>
            `
        }
    }

    {% if paypal_enabled and paypal_data %}
    // PayPal Integration
    const paypalData = {
        cartId: '{{ paypal_data.cart_id }}',
        items: {{ paypal_data.items|safe }},
        subtotal: {{ paypal_data.subtotal }}
    };

    paypal.Buttons({
        style: {
            layout: 'vertical',
            color: 'gold',
            shape: 'rect',
            label: 'paypal',
            height: 50
        },

        // Crear la orden cuando el usuario hace clic
        createOrder: function(data, actions) {
            // Construir items para PayPal
            const items = paypalData.items.map(item => ({
                name: item.name,
                description: item.description || '',
                quantity: String(item.quantity),
                unit_amount: {
                    currency_code: 'MXN',
                    value: String(item.itemCost.toFixed(2))
                }
            }));

            const itemTotal = paypalData.items.reduce((sum, item) => sum + item.itemTotal, 0);

            return actions.order.create({
                purchase_units: [{
                    reference_id: paypalData.cartId,
                    description: 'Compra en CuentasMexico',
                    amount: {
                        currency_code: 'MXN',
                        value: String(itemTotal.toFixed(2)),
                        breakdown: {
                            item_total: {
                                currency_code: 'MXN',
                                value: String(itemTotal.toFixed(2))
                            }
                        }
                    },
                    items: items
                }]
            });
        },

        // Capturar el pago cuando el usuario aprueba
        onApprove: function(data, actions) {
            // Mostrar loading
            document.getElementById('paypal-button-container').style.display = 'none';
            document.getElementById('paypal-loading').style.display = 'block';

            return actions.order.capture().then(function(details) {
                // Enviar al backend para procesar la entrega
                fetch('{% url "paypal_capture_order" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: data.orderID,
                        cart_id: paypalData.cartId
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // Redirigir a mi cuenta
                        window.location.href = result.redirect_url;
                    } else {
                        alert('Error procesando el pago: ' + result.message);
                        document.getElementById('paypal-button-container').style.display = 'block';
                        document.getElementById('paypal-loading').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error de conexion. Por favor intenta de nuevo.');
                    document.getElementById('paypal-button-container').style.display = 'block';
                    document.getElementById('paypal-loading').style.display = 'none';
                });
            });
        },

        // Manejar cancelacion
        onCancel: function(data) {
            console.log('Pago cancelado por el usuario');
        },

        // Manejar errores
        onError: function(err) {
            console.error('Error PayPal:', err);
            alert('Ocurrio un error con PayPal. Por favor intenta de nuevo.');
        }
    }).render('#paypal-button-container');
    {% endif %}

    {% if stripe_enabled and stripe_data %}
    // Stripe Integration
    const stripeData = {
        cartId: '{{ stripe_data.cart_id }}',
        items: {{ stripe_data.items|safe }},
        subtotal: {{ stripe_data.subtotal }}
    };

    document.getElementById('stripe-checkout-button').addEventListener('click', function() {
        // Mostrar loading
        document.getElementById('stripe-checkout-button').style.display = 'none';
        document.getElementById('stripe-loading').style.display = 'block';

        // Crear sesion de checkout en el backend
        fetch('{% url "stripe_create_checkout_session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                cart_id: stripeData.cartId
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success && result.url) {
                // Redirigir a Stripe Checkout
                window.location.href = result.url;
            } else {
                alert('Error: ' + (result.message || 'No se pudo crear la sesion de pago'));
                document.getElementById('stripe-checkout-button').style.display = 'flex';
                document.getElementById('stripe-loading').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexion. Por favor intenta de nuevo.');
            document.getElementById('stripe-checkout-button').style.display = 'flex';
            document.getElementById('stripe-loading').style.display = 'none';
        });
    });
    {% endif %}
</script>

{% endblock extrajs %}