{% extends "adm/base/base.html" %}
{% load static %}
{% block title %}
    Ventas
{% endblock title %}
{% block head %}
    <style>
        .sale-create-page .service-list {
            max-height: 330px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background: #fff;
        }

        .sale-create-page .service-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .sale-create-page .service-search {
            flex: 1 1 200px;
        }

        .sale-create-page .service-actions {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .sale-create-page .service-counter {
            font-size: 0.8rem;
            color: #4b5563;
            margin-bottom: 0.55rem;
        }

        .sale-create-page .service-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.55rem 0.65rem;
            margin-bottom: 0.45rem;
            cursor: pointer;
            transition: border-color 0.15s ease, background-color 0.15s ease;
            background: #ffffff;
        }

        .sale-create-page .service-item:hover {
            border-color: #93c5fd;
            background: #f8fbff;
        }

        .sale-create-page .service-item.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .sale-create-page .service-list .form-check {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin: 0;
            padding-left: 0;
            min-height: 1.5rem;
        }

        .sale-create-page .service-list .form-check-input {
            margin: 0;
            float: none;
            flex-shrink: 0;
        }

        .sale-create-page .service-list .form-check-label {
            width: 100%;
            cursor: pointer;
            margin: 0;
        }

        .sale-create-page .info-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .sale-create-page .info-badges .badge {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.55rem 0.75rem;
            background: #eef4ff;
            color: #0d6efd;
            border: 1px solid #d8e7ff;
        }

        .sale-create-page .table-hint {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .sale-create-page .mobile-result-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.6rem;
            padding: 0.7rem;
            background: #fff;
        }

        .sale-create-page .mobile-result-card.selected {
            border: 2px solid #16a34a;
        }

        .sale-create-page .mobile-result-card-selectable {
            cursor: pointer;
        }

        .sale-create-page .mobile-result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.45rem 0.6rem;
            margin-top: 0.6rem;
        }

        .sale-create-page .mobile-result-grid small {
            color: #6b7280;
            font-size: 0.72rem;
            text-transform: uppercase;
        }

        .sale-create-page .mobile-result-grid span,
        .sale-create-page .mobile-result-grid code {
            font-size: 0.82rem;
            overflow-wrap: anywhere;
        }

        .sale-create-page .table td,
        .sale-create-page .table th {
            white-space: nowrap;
        }

        @media (max-width: 767.98px) {
            .sale-create-page .table {
                font-size: 0.82rem;
            }
        }
    </style>
{% endblock head %}
{% block body %}
    <div class="container-fluid py-3 sale-create-page">
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <h1 class="h3 mb-2">Venta a {{ customer.username }}</h1>
                <div class="info-badges">
                    {% for key, value in availables.items %}
                        <span class="badge rounded-pill">{{ key }}: {{ value }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <form action="{% url 'adm:sales_create' customer.id %}" method="post">
            <input type="hidden" name="customer" id="customer" value="{{ customer.id }}">
            {% csrf_token %}

            <div class="row g-3">
                <div class="col-12 col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h4 class="h6 mb-3">Selecciona uno o m√°s servicios</h4>
                            <div class="service-toolbar">
                                <input type="text"
                                       id="service-search"
                                       class="form-control form-control-sm service-search"
                                       placeholder="Filtrar servicios..."
                                       onkeydown="if(event.key==='Enter')event.preventDefault()">
                                <div class="service-actions">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="service-select-visible">Seleccionar visibles</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="service-clear">Limpiar</button>
                                </div>
                            </div>
                            <div class="service-counter">
                                Seleccionados: <strong id="service-selected-count">0</strong>
                            </div>
                            <div class="service-list">
                                {% for s in services %}
                                    <div class="service-item" data-service-item data-service-name="{{ s.description|lower }}">
                                        <div class="form-check">
                                        <input class="form-check-input serv"
                                               type="checkbox"
                                               value="{{ s.id }}"
                                               name="service"
                                               id="{{ s.id }}"
                                               onclick="services()">
                                        <label class="form-check-label" for="{{ s.id }}">{{ s.description }}</label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-8">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label for="created_at" class="form-label">Fecha Venta</label>
                                    <input type="datetime"
                                           class="form-control"
                                           name="created_at"
                                           id="created_at"
                                           value="{{ created_at|date:"Y-m-d H:i:sO" }}">
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="price" class="form-label">Precio</label>
                                    <input type="number" name="price" id="price" class="form-control" required>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="duration" class="form-label">Duraci√≥n</label>
                                    <select name="duration" id="duration" class="form-control" required>
                                        <option value="">------</option>
                                        <option value="1">1 Mes</option>
                                        <option value="2">2 Meses</option>
                                        <option value="3">3 Meses</option>
                                        <option value="4">4 Meses</option>
                                        <option value="5">5 Meses</option>
                                        <option value="6">6 Meses</option>
                                        <option value="7">7 Meses</option>
                                        <option value="8">8 Meses</option>
                                        <option value="9">9 Meses</option>
                                        <option value="10">10 Meses</option>
                                        <option value="11">11 Meses</option>
                                        <option value="12">1 A√±o</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="comp" class="form-label">Comprobante</label>
                                    <div class="input-group">
                                        <input type="text" name="comp" id="comp" class="form-control" required>
                                        <button class="btn btn-outline-secondary" type="button" id="generateUUID" title="Generar UUID">
                                            <i class="bi bi-hash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="bank" class="form-label">Cuenta</label>
                                    <input name="bank" id="bank" class="form-control" list="banklist" required>
                                    <datalist id="banklist">
                                        {% for b in bank %}
                                            <option value="{{ b.id }}">{{ b.headline }} - {{ b.bank_name }} - {{ b.card_number }}</option>
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="method" class="form-label">M√©todo de Pago</label>
                                    <input name="method"
                                           id="method"
                                           class="form-control"
                                           list="paymentlist"
                                           required>
                                    <datalist id="paymentlist">
                                        {% for pay in payment %}<option value="{{ pay.id }}">{{ pay.description }}</option>{% endfor %}
                                    </datalist>
                                </div>
                                <div class="col-12">
                                    <input type="submit" id="end" value="Terminar" class="btn btn-cm w-100" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="accounts" class="not-visible mt-4">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-2 align-items-center">
                            <div class="col-12 col-md-6 col-lg-4">
                                <input type="text" id="search-email" placeholder="Buscar por email..." class="form-control" onkeydown="if(event.key==='Enter')event.preventDefault()">
                            </div>
                            <div class="col-12 col-md-6 col-lg-8 text-md-end">
                                <span class="table-hint">En m√≥vil puedes deslizar horizontalmente para ver todas las columnas.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-12 col-xl-7">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="h6 mb-3">Cuentas disponibles</h5>
                                <div class="d-grid gap-2 d-md-none" id="results-box-mobile"></div>
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th></th>
                                                <th>Email</th>
                                                <th>Clave</th>
                                                <th>Vencimient Cta</th>
                                                <th>Perfil</th>
                                            </tr>
                                        </thead>
                                        <tbody class="t-img" id="results-box">
                                            <!--Rellenado Automaticamente-->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-xl-5">
                        <div id="main-accdetail" class="not-visible">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <h5 class="h6 mb-3">Detalle de cuenta seleccionada</h5>
                                    <div class="d-grid gap-2 d-md-none" id="accdetail-mobile"></div>
                                    <div class="table-responsive d-none d-md-block">
                                        <table class="table table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th>E-mail</th>
                                                    <th>Cliente</th>
                                                    <th>Vencimient Cliente</th>
                                                    <th>Perfil</th>
                                                    <th>Acci√≥n</th>
                                                </tr>
                                            </thead>
                                            <tbody class="t-img" id="accdetail">
                                                <!--Rellenado Automaticamente-->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock body %}
{% block extrajs %}
    <script src="{% static 'adm/js/sales.js' %}?v=3"></script>
    <script>
        // Script de b√∫squeda - agregado directamente en el template para evitar problemas de cach√©
        $(document).ready(function() {
            console.log('‚úÖ B√öSQUEDA: Listener configurado');
            
            $(document).on('input', '#search-email', function(e) {
                const searchTerm = $(this).val();
                console.log('üîç B√öSQUEDA: T√©rmino:', searchTerm);
                console.log('üìä B√öSQUEDA: Total cuentas:', window.allAccounts ? window.allAccounts.length : 0);
                
                if (!window.allAccounts || window.allAccounts.length === 0) {
                    console.log('‚ùå No hay cuentas cargadas');
                    return;
                }
                
                const resultsBox = document.getElementById("results-box");
                const filteredAccounts = window.allAccounts.filter(account => 
                    account.email.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                console.log('‚úÖ Resultados filtrados:', filteredAccounts.length);
                
                resultsBox.innerHTML = "";

                if (typeof window.renderSalesSearchResults === 'function') {
                    window.renderSalesSearchResults(filteredAccounts);
                    return;
                }

                if (filteredAccounts.length === 0) {
                    resultsBox.innerHTML = '<tr><td colspan="6" class="text-center"><b>No se encontraron resultados</b></td></tr>';
                    return;
                }
            });

            // Generar UUID para el comprobante
            $('#generateUUID').on('click', function() {
                // Generar UUID v4
                function generateUUID() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                $('#comp').val(generateUUID());
            });

            function syncServiceSelectionUI() {
                const checked = document.querySelectorAll('.serv:checked');
                $('#service-selected-count').text(checked.length);

                $('[data-service-item]').each(function() {
                    const checkbox = $(this).find('.serv').get(0);
                    if (checkbox && checkbox.checked) {
                        $(this).addClass('selected');
                    } else {
                        $(this).removeClass('selected');
                    }
                });
            }

            $(document).on('click', '[data-service-item]', function(event) {
                if ($(event.target).closest('input, label, button, a').length) {
                    return;
                }

                const checkbox = $(this).find('.serv').get(0);
                if (!checkbox) return;

                checkbox.checked = !checkbox.checked;
                if (typeof services === 'function') {
                    services();
                }
                syncServiceSelectionUI();
            });

            $(document).on('change', '.serv', function() {
                syncServiceSelectionUI();
            });

            $('#service-search').on('input', function() {
                const term = ($(this).val() || '').toLowerCase().trim();
                $('[data-service-item]').each(function() {
                    const serviceName = ($(this).data('service-name') || '').toString();
                    const visible = !term || serviceName.includes(term);
                    $(this).toggle(visible);
                });
            });

            $('#service-select-visible').on('click', function() {
                $('[data-service-item]:visible .serv').each(function() {
                    this.checked = true;
                });
                if (typeof services === 'function') {
                    services();
                }
                syncServiceSelectionUI();
            });

            $('#service-clear').on('click', function() {
                $('.serv').each(function() {
                    this.checked = false;
                });
                if (typeof services === 'function') {
                    services();
                }
                syncServiceSelectionUI();
            });

            syncServiceSelectionUI();
        });
    </script>
{% endblock extrajs %}
