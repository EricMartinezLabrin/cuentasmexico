{% extends "adm/base/base.html" %}
{% load static %}
{% block title %}
    Ventas
{% endblock title %}
{% block body %}
    <h1>Venta a {{ customer.username }}</h1>
    <!--Available Account-->
    <div class="d-flex mb-4">
        {% for key,value in availables.items %}<b class="ms-2">{{ key }}:</b> {{ value }}{% endfor %}
    </div>
    <h4>Selecciona uno o m√°s Servicios</h4>
    <form action="{% url 'adm:sales_create' customer.id %}" method="post">
        <input type="hidden" name="customer" id="customer" value="{{ customer.id }}">
        <div class="d-flex">
            <div class="service m-2">
                {% csrf_token %}
                {% for s in services %}
                    <div class="form-check pb-2" id="service-group">
                        <input class="form-check-input serv "
                               type="checkbox"
                               value="{{ s.id }}"
                               name="service"
                               id="{{ s.id }}"
                               onclick="services()">
                        <label class="form-check-label" for="{{ s.id }}">{{ s.description }}</label>
                    </div>
                {% endfor %}
            </div>
            <div class="price m-2">
                <label for="created_at">Fecha Venta</label>
                <input type="datetime"
                       class="form-control"
                       name="created_at"
                       id="created_at"
                       value="{{ created_at|date:"Y-m-d H:i:sO" }}">
            </div>
            <div class="price m-2">
                <label for="price">Precio:</label>
                <input type="number" name="price" id="price" class="form-control" required>
            </div>
            <div class="duration m-2">
                <label for="duration">Duraci√≥n:</label>
                <select name="duration" id="duration" class="form-control">
                    <option value="None">------</option>
                    <option value="1">1 Mes</option>
                    <option value="2">2 Meses</option>
                    <option value="3">3 Meses</option>
                    <option value="4">4 Meses</option>
                    <option value="5">5 Meses</option>
                    <option value="6">6 Meses</option>
                    <option value="7">7 Meses</option>
                    <option value="8">8 Meses</option>
                    <option value="9">9 Meses</option>
                    <option value="10">10 Meses</option>
                    <option value="11">11 Meses</option>
                    <option value="12">1 A√±o</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="comp m-2">
                <label for="price">Comprobante:</label>
                <input type="text" name="comp" id="comp" class="form-control" required>
            </div>
            <div class="bank m-2">
                <label for="bank">Cuenta:</label>
                <input name="bank" id="bank" class="form-control" list="banklist" required>
                <datalist id="banklist">
                    {% for b in bank %}
                        <option value="{{ b.id }}">{{ b.headline }} - {{ b.bank_name }} - {{ b.card_number }}</option>
                    {% endfor %}
                </datalist>
            </div>
            <div class="method m-2">
                <label for="method">Metodo de Pago:</label>
                <input name="method"
                       id="method"
                       class="form-control"
                       list="paymentlist"
                       required>
                <datalist id="paymentlist">
                    {% for pay in payment %}<option value="{{ pay.id }}">{{ pay.description }}</option>{% endfor %}
                </datalist>
            </div>
            <input type="submit" id="end" value="terminar" class="btn btn-cm" disabled>
        </div>
        <div id="accounts" class="not-visible">
            <div class="d-flex mb-3">
                <input type="text" id="search-email" placeholder="Buscar por email..." class="form-control w-25">
            </div>
            <div class="d-flex">
                <div class="accfree">
                    <table class="table table-hover">
                        <thead>
                            <th></th>
                            <th></th>
                            <th>Email</th>
                            <th>Clave</th>
                            <th>Vencimient Cta</th>
                            <th>Perfil</th>
                        </thead>
                        <tbody class="t-img" id="results-box">
                            <!--Rellenado Automaticamente-->
                        </tbody>
                    </table>
                </div>
                <div id="main-accdetail" class="ms-5 not-visible">
                    <table class="table table-hover">
                        <thead>
                            <th></th>
                            <th>E-mail</th>
                            <th>Cliente</th>
                            <th>Vencimient Cliente</th>
                            <th>Perfil</th>
                        </thead>
                        <tbody class="t-img" id="accdetail">
                            <!--Rellenado Automaticamente-->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </form>
{% endblock body %}
{% block extrajs %}
    <script src="{% static 'adm/js/sales.js' %}?v=2"></script>
    <script>
        // Script de b√∫squeda - agregado directamente en el template para evitar problemas de cach√©
        $(document).ready(function() {
            console.log('‚úÖ B√öSQUEDA: Listener configurado');
            
            $(document).on('input', '#search-email', function(e) {
                const searchTerm = $(this).val();
                console.log('üîç B√öSQUEDA: T√©rmino:', searchTerm);
                console.log('üìä B√öSQUEDA: Total cuentas:', window.allAccounts ? window.allAccounts.length : 0);
                
                if (!window.allAccounts || window.allAccounts.length === 0) {
                    console.log('‚ùå No hay cuentas cargadas');
                    return;
                }
                
                const resultsBox = document.getElementById("results-box");
                const filteredAccounts = window.allAccounts.filter(account => 
                    account.email.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                console.log('‚úÖ Resultados filtrados:', filteredAccounts.length);
                
                resultsBox.innerHTML = "";
                
                if (filteredAccounts.length === 0) {
                    resultsBox.innerHTML = '<tr><td colspan="6" class="text-center"><b>No se encontraron resultados</b></td></tr>';
                    return;
                }
                
                filteredAccounts.forEach((data, index) => {
                    let borderStyle = index === 0 ? "border: 2px solid green;" : "";
                    // Asegurar que el logo URL sea v√°lido (escapar caracteres especiales si es necesario)
                    const logoUrl = data.logo || '';
                    resultsBox.innerHTML += `
                        <tr style="${borderStyle}">
                            <td><input class="form-check-input details" name="serv" id="${data.id}" type="checkbox" value="${data.id}" onclick="detail()"></td>
                            <label for="${data.id}">
                            <td><img src="${logoUrl}" width="20" style="object-fit: contain;"></td>
                            <td>${data.email}</td>
                            <td>${data.password}</td>
                            <td>${moment(data.expiration_acc).format("DD/MM/YYYY")}</td>
                            <td>${data.profile}</td>            
                            <br>
                            </label>
                        </tr>
                    `;
                });
            });
        });
    </script>
{% endblock extrajs %}
