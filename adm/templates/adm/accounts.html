{% extends 'adm/base/base.html' %}
{% load pagination_filters %}
{% block title %}
    Cuentas Disponibles
{% endblock title %}
{% block body %}
    <h1>Administración</h1>
    <a href="{% url 'adm:accounts_create' %}" class="btn btn-cm mb-3">Crear Nueva</a>
    <a href="{% url 'adm:accounts_expired' %}" class="btn btn-primary mb-3">Vencidos</a>
    <a href="{% url 'adm:SearchRenewAcc' %}" class="btn btn-cm-cancel mb-3">Renovaciones</a>
    {% if not venues.object_list %}
        <p>
            <strong>No Hay Cuentas Disponibles</strong>
        </p>
        <a href=" {% url 'adm:accounts' %} ">Volver</a>
    {% else %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-success {% if message.tags %}alert-{{ message.tags }}{% endif %}"
                     role="alert">{{ message }}</div>
            {% endfor %}
        {% endif %}
        {% comment %} Form Filters {% endcomment %}
        <section>
            <form class="row row-cols-lg-auto g-3 align-items-center filter"
                  method="POST">
                {% csrf_token %}
                {% comment %} Account {% endcomment %}
                <div class="col-12">
                    <label class="visually-hidden" for="account_name_select">{{ form.account_name.label }}</label>
                    <div class="input-group">
                        <div class="input-group-text">{{ form.account_name.label }}</div>
                        {% if form_data.account_name %}
                            <select name="account_name" class="form-select" id="account_name_select">
                                {% for choice in form.account_name.field.choices %}
                                    <option value="{{ choice.0 }}"
                                            {% if form_data.account_name == choice.0|stringformat:"s" %}selected{% endif %}>
                                        {{ choice.1 }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            {{ form.account_name }}
                        {% endif %}
                    </div>
                </div>
                {% comment %} E-Mail {% endcomment %}
                <div class="col-12">
                    <label class="visually-hidden" for="email_input">{{ form.email.label }}</label>
                    <div class="input-group">
                        <div class="input-group-text">{{ form.email.label }}</div>
                        <input type="text"
                               id="email_input"
                               name="{{ form.email.name }}"
                               value="{% if form_data.email %}{{ form_data.email }}{% endif %}"
                               autocomplete="off">
                    </div>
                </div>
                {% comment %} Status {% endcomment %}
                <div class="col-12">
                    <label class="visually-hidden" for="status_select">Estado</label>
                    <div class="input-group">
                        <div class="input-group-text">Estado</div>
                        <select name="status" class="form-control" id="status_select">
                            <option value="">------</option>
                            <option value="True" {% if form_data.status == "True" %}selected{% endif %}>Activa</option>
                            <option value="False" {% if form_data.status == "False" %}selected{% endif %}>Inactiva</option>
                        </select>
                    </div>
                </div>
                <div class="col-12">
                    <input type="submit" class="btn btn-info" value="Filtrar">
                    <a href="{% url 'adm:accounts' %}" class="btn btn-cm-cancel">Limpiar Filtro</a>
                </div>
            </form>
        </section>
        <table class="table table-striped table-hover details">
            <thead>
                <tr>
                    <th>Cuenta</th>
                    <th>Creación</th>
                    <th>Vencimiento</th>
                    <th>Creador por:</th>
                    <th>Modificado por:</th>
                    <th>Proveedor</th>
                    <th>E-Mail</th>
                    <th>Clave</th>
                    <th>Cliente</th>
                    <th>Perfil</th>
                    <th>Pin</th>
                    <th>Comentarios</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for active in venues %}
                    <tr class="t-img">
                        <td>
                            {% if active.account_name.logo %}
                                <img src="/media/{{ active.account_name.logo }}"
                                     alt="{{ active.account_name.description }}"
                                     width="40"
                                     loading="lazy">
                            {% else %}
                                <span>{{ active.account_name.description|truncatechars:10 }}</span>
                            {% endif %}
                        </td>
                        <td>{{ active.created_at|date:"d-M-Y" }}</td>
                        <td>
                            {% if active.expiration_date|date:"Y-m-d" <= today|date:"Y-m-d" %}
                                <span style="color: red">{{ active.expiration_date|date:"d-M-Y" }}</span>
                            {% else %}
                                {{ active.expiration_date|date:"d-M-Y" }}
                            {% endif %}
                        </td>
                        <td>{{ active.created_by.username|default:"N/A" }}</td>
                        <td>{{ active.modified_by.username|default:"N/A" }}</td>
                        <td>{{ active.supplier.name|default:"N/A" }}</td>
                        <td>
                            {{ active.email }}
                            {% if active.renovable %}<i class="bi bi-star-fill" style="color:gold" title="Renovable"></i>{% endif %}
                            {% if not active.status %}<i class="bi bi-x-circle-fill" style="color:red" title="Inactiva"></i>{% endif %}
                        </td>
                        <td>{{ active.password }}</td>
                        <td>{{ active.customer.username|default:"Disponible" }}</td>
                        <td>{{ active.profile|default:"1" }}</td>
                        <td>{{ active.pin|default:"" }}</td>
                        <td>{{ active.comments|default:""|truncatechars:30 }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{% url 'adm:accounts_update' active.id %}"
                                   class="btn btn-sm btn-outline-primary"
                                   title="Editar">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <a href="{% url 'adm:accounts_active' active.status active.id %}"
                                   class="btn btn-sm btn-outline-warning"
                                   title="{% if active.status %}Desactivar{% else %}Activar{% endif %}">
                                    <i class="bi bi-file-earmark-{% if active.status %}minus{% else %}plus{% endif %}"></i>
                                </a>
                                <a href="{% url 'adm:accounts_update_profile' active.id %}"
                                   class="btn btn-sm btn-outline-info"
                                   title="Perfil">
                                    <i class="bi bi-person-badge"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination">
            {% comment %} mostramos si no hay pagina previa {% endcomment %}
            {% if not venues.has_previous and venues.has_next %}
                <nav aria-label="...">
                    <ul class="pagination">
                        <li class="page-item disabled">
                            <span class="page-link">Anterior</span>
                        </li>
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ venues.number }}</span>
                        </li>
                        <li class="page-item">
                            <a class="page-link"
                               href="{% filter_pagination_url venues.next_page_number filter_query %}">{{ venues.next_page_number }}</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link"
                               href="{% filter_pagination_url venues.paginator.num_pages filter_query %}">{{ venues.paginator.num_pages }}</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link"
                               href="{% filter_pagination_url venues.next_page_number filter_query %}">Siguiente</a>
                        </li>
                    </ul>
                </nav>
                {% comment %} mostramos si hay pagina y previa y hay pagina siguiente {% endcomment %}
            {% elif venues.has_previous and venues.has_next %}
                <nav aria-label="...">
                    <ul class="pagination">
                        <li class="page-item">
                            <a class="page-link"
                               href="{% filter_pagination_url venues.previous_page_number filter_query %}">Anterior</a>
                        </li>
                        {% if venues.previous_page_number != 1 %}
                            <li class="page-item">
                                <a class="page-link" href="{% filter_pagination_url 1 filter_query %}">1</a>
                            </li>
                            <li class="page-item active" aria-current="page">
                            {% endif %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="{% filter_pagination_url venues.previous_page_number filter_query %}">{{ venues.previous_page_number }}</a>
                            </li>
                            <li class="page-item active" aria-current="page">
                                <a class="page-link" href="#">{{ venues.number }}</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link"
                                   href="{% filter_pagination_url venues.next_page_number filter_query %}">{{ venues.next_page_number }}</a>
                            </li>
                            {% if  venues.paginator.num_pages != venues.next_page_number %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="{% filter_pagination_url venues.paginator.num_pages filter_query %}">{{ venues.paginator.num_pages }}</a>
                                </li>
                            {% endif %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="{% filter_pagination_url venues.next_page_number filter_query %}">Siguiente</a>
                            </li>
                        </ul>
                    </nav>
                    {% comment %} mostramos si no hay pagina siguiente {% endcomment %}
                {% elif venues.has_previous and not venues.has_next %}
                    <nav aria-label="...">
                        <ul class="pagination">
                            <li class="page-item">
                                <a class="page-link"
                                   href="{% filter_pagination_url venues.previous_page_number filter_query %}">Anterior</a>
                            </li>
                            {% if  venues.previous_page != 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{% filter_pagination_url 1 filter_query %}">1</a>
                                </li>
                            {% endif %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="{% filter_pagination_url venues.previous_page_number filter_query %}">{{ venues.previous_page_number }}</a>
                            </li>
                            <li class="page-item active" aria-current="page">
                                <a class="page-link" href="#">{{ venues.number }}</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Siguiente</a>
                            </li>
                        </ul>
                    </nav>
                {% else %}
                    <nav aria-label="...">
                        <ul class="pagination">
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Anterior</a>
                            </li>
                            <li class="page-item active" aria-current="page">
                                <a class="page-link" href="#">1</a>
                            </li>
                            <li class="page-item disabled">
                                <a class="page-link" href="#">Siguiente</a>
                            </li>
                        </ul>
                    </nav>
                {% endif %}
            {% endif %}
        </div>
    {% endblock body %}
    {% block extrajs %}
        <script>
    // Optimización del input de email
    const emailInput = document.getElementById("email_input");
    if (emailInput) {
        let timeoutId;
        emailInput.addEventListener("input", function() {
            // Debounce para evitar múltiples ejecuciones
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                this.value = this.value.trim();
            }, 300);
        });
    }
    
    // Mejorar UX con loading states
    const filterForm = document.querySelector('.filter form');
    if (filterForm) {
        filterForm.addEventListener('submit', function() {
            const submitBtn = this.querySelector('input[type="submit"]');
            if (submitBtn) {
                submitBtn.value = 'Filtrando...';
                submitBtn.disabled = true;
            }
        });
    }
    
    // Lazy loading de imágenes si el navegador no lo soporta
    if ('loading' in HTMLImageElement.prototype === false) {
        const images = document.querySelectorAll('img[loading="lazy"]');
        images.forEach(img => {
            img.style.opacity = '0';
            img.onload = function() {
                this.style.opacity = '1';
                this.style.transition = 'opacity 0.3s';
            };
        });
    }
        </script>
    {% endblock extrajs %}
