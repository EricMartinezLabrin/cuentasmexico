{% extends "adm/base/base.html" %}
{% load static %}
{% block title %}
    Por Cobrar
{% endblock title %}
{% block body %}
    <h2 class="mb-4 text-cm">
    Quedan <span class="fw-bold">{{ left }}</span> cuenta{{ left|pluralize:",s" }} por liberar
    </h2>
    <div class="row mb-3 align-items-end">
        <div class="col-md-5">
            <form method="get" class="d-flex gap-2">
                <label for="date" class="form-label me-2">Fecha de vencimiento</label>
                <input type="date" name="date" id="date" class="form-control">
                <button type="submit" class="btn btn-cm">Buscar</button>
            </form>
        </div>
        <div class="col-md-3">
            <form method="get">
                <input type="hidden" name="date" value="{{ tomorrow|date:'Y-m-d' }}">
                <button type="submit" class="btn btn-primary w-100">Vence Mañana</button>
            </form>
        </div>
        <div class="col-md-2">
            <a href="{% url 'adm:receivable' %}" class="btn btn-cm-cancel w-100">Limpiar Filtro</a>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle shadow-sm">
            <thead class="table-light text-center">
                <tr>
                    <th></th>
                    <th></th>
                    <th>Cliente</th>
                    <th>Email</th>
                    <th>Contraseña</th>
                    <th>Perfil</th>
                    <th>Vencimiento Cliente</th>
                    <th>Vencimiento Cuenta</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for rece in object_list %}
                    <tr class="text-center">
                        <td class="text-center">
                            {% if rece.account.account_name.logo %}
                           <img src="{{ rece.account.account_name.logo.url }}"
                               alt="{{ rece.account.account_name.name }}"
                                     width="36"
                                     height="36"
                                     class="d-block mx-auto"
                               title="{{ rece.account.account_name.description }}">
                           <div class="small mt-1 fw-semibold">{{ rece.account.account_name.name }}</div>
                            {% else %}
                                <span title="{{ rece.account.account_name.description }}" class="fw-bold">{{ rece.account.account_name.name }}</span>
                            {% endif %}
                        </td>
                    
                    <td>
                        {% if rece.account.renovable == True %}
                            <i class="bi bi-star-fill star-renovable" title="Renovable"></i>
                        {% endif %}
                    </td>
                    <td class="fw-semibold">{{ rece.customer.username }}</td>
                    <td>{{ rece.account.email }}</td>
                    <td>{{ rece.account.password }}</td>
                    <td>{{ rece.account.profile }}</td>
                    <td>{{ rece.expiration_date|date:'d-m-Y' }}</td>
                    <td>{{ rece.account.expiration_date|date:'d-m-Y' }}</td>
                    <td class="position-relative preview-hover-cell">
                        <span class="preview-hover-trigger">
                            {% if rece.account.status %}
                                <span class="badge bg-success">Activa</span>
                            {% else %}
                                <span class="badge bg-danger">Inactiva</span>
                            {% endif %}
                        </span>
                    <div class="preview-hover-box shadow border bg-white p-2">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Email</th>
                                        <th>Perfil</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for acc in rece.account.account_name.account_set.all %}
                                        {% if acc.email == rece.account.email and acc.password == rece.account.password %}
                                            <tr>
                                                <td>{{ acc.email }}</td>
                                                <td>{{ acc.profile }}</td>
                                                <td>
                                                    {% if acc.status %}
                                                        <span class="badge bg-success">Activa</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Inactiva</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <form method="post"
                            class="toggle-status-form d-inline"
                            data-url="{% url 'adm:accounts_active' rece.account.status|yesno:'false,true' rece.account.id %}">
                            {% csrf_token %}
                            <button type="submit"
                                    class="btn btn-sm btn-warning ms-2"
                                    title="Cambiar estado">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </form>
                    </td>
                    <td>
                        <div class="d-flex gap-2 justify-content-center">
                            <a href="{% url 'adm:release' rece.id %}"
                               class="btn btn-outline-success btn-sm"
                               title="Liberar">
                                <i class="bi bi-check-circle"></i>
                            </a>
                            <button type="button"
                               class="btn btn-outline-primary btn-sm quick-release-btn"
                               data-sale-id="{{ rece.id }}"
                               title="Liberar rápido">
                                <i class="bi bi-lightning-fill"></i>
                            </button>
                                     <a href="#"
                                         onclick="copyAcc('{{ rece.id }}')"
                               class="btn btn-outline-secondary btn-sm"
                               title="Copiar mensaje">
                                <i class="bi bi-clipboard"></i>
                            </a>
                            <a href="{% url 'adm:receivable' %}?email={{ rece.account.email }}"
                               class="btn btn-outline-info btn-sm"
                               title="Ver detalles">
                                <i class="bi bi-eye"></i>
                            </a>
                        </div>
                        <textarea id="{{ rece.id }}" rows="1" cols="1" readonly class="visually-hidden textarea-copy-message">Buenas tardes amig@, le recuerdo que su cuenta  {{ rece.account.account_name }} ya venció, para seguir utilizándola debe renovar. Por ser cliente frecuente tendrás un 10% de descuento si renuevas por 3 meses o más el día de hoy.</textarea>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% include "adm/base/paginator.html" %}
{% endblock body %}
{% block head %}
    <link rel="stylesheet" href="{% static 'adm/css/receivable.css' %}">
{% endblock head %}
{% block extrajs %}
    <script>
    function copyAcc(copyId){
        const codigoACopiar = document.getElementById(copyId);
        codigoACopiar.classList.remove('visually-hidden');
        codigoACopiar.select();
        document.execCommand('copy');
        setTimeout(() => {
            codigoACopiar.classList.add('visually-hidden');
        }, 500);
    }

    // AJAX para cambiar estado sin recargar
    document.querySelectorAll('.toggle-status-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const url = form.getAttribute('data-url');
            const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cambia el badge de estado visualmente
                    const badge = form.parentElement.querySelector('.badge');
                    if (data.new_status) {
                        badge.classList.remove('bg-danger');
                        badge.classList.add('bg-success');
                        badge.textContent = 'Activa';
                    } else {
                        badge.classList.remove('bg-success');
                        badge.classList.add('bg-danger');
                        badge.textContent = 'Inactiva';
                    }
                    // Cambia el data-url para el próximo toggle
                    const newUrl = url.replace(/(true|false)/, data.new_status ? 'false' : 'true');
                    form.setAttribute('data-url', newUrl);

                    // Actualiza la vista previa de cuentas similares
                    const previewBox = form.parentElement.querySelector('.preview-hover-box');
                    if (previewBox) {
                        // Cambia todos los badges de la tabla de preview
                        previewBox.querySelectorAll('tr').forEach(function(row) {
                            const badge = row.querySelector('.badge');
                            if (badge) {
                                if (data.new_status) {
                                    badge.classList.remove('bg-danger');
                                    badge.classList.add('bg-success');
                                    badge.textContent = 'Activa';
                                } else {
                                    badge.classList.remove('bg-success');
                                    badge.classList.add('bg-danger');
                                    badge.textContent = 'Inactiva';
                                }
                            }
                        });
                    }
                }
            });
        });
    });

    // Mostrar/ocultar la vista previa de cuentas similares
    document.querySelectorAll('.preview-hover-trigger').forEach(function(trigger) {
        trigger.addEventListener('mouseenter', function() {
            const box = this.parentElement.querySelector('.preview-hover-box');
            if (box) box.style.display = 'block';
        });
        trigger.addEventListener('mouseleave', function() {
            const box = this.parentElement.querySelector('.preview-hover-box');
            if (box) box.style.display = 'none';
        });
        // Para accesibilidad con teclado
        trigger.addEventListener('focus', function() {
            const box = this.parentElement.querySelector('.preview-hover-box');
            if (box) box.style.display = 'block';
        });
        trigger.addEventListener('blur', function() {
            const box = this.parentElement.querySelector('.preview-hover-box');
            if (box) box.style.display = 'none';
        });
    });

    // Liberar cuenta sin recargar la página (Quick Release)
    document.querySelectorAll('.quick-release-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const saleId = this.getAttribute('data-sale-id');
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]') ? 
                            document.querySelector('[name=csrfmiddlewaretoken]').value : 
                            getCookie('csrftoken');
            
            if (confirm('¿Está seguro de que desea liberar esta cuenta?')) {
                fetch(`/adm/receivable/quick-release/${saleId}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remover la fila de la tabla
                        const row = btn.closest('tr');
                        row.style.opacity = '0.5';
                        setTimeout(() => {
                            row.remove();
                            // Actualizar el contador
                            const counterSpan = document.querySelector('span.fw-bold');
                            if (counterSpan) {
                                let count = parseInt(counterSpan.textContent);
                                counterSpan.textContent = Math.max(0, count - 1);
                            }
                        }, 300);
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al liberar la cuenta');
                });
            }
        });
    });

    // Función auxiliar para obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
{% endblock extrajs %}
