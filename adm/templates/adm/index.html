{% extends 'adm/base/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
    Dashboard
{% endblock title %}

{% block head %}
<style>
    .clickable-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .clickable-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .clickable-card .card-body {
        position: relative;
    }

    .clickable-card .mt-2 {
        font-size: 0.9rem;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }

    .clickable-card:hover .mt-2 {
        opacity: 1;
    }
</style>
{% endblock head %}

{% block body %}
    <h1>Dashboard</h1>
    <div class="d-flex">
        <table class="table table-hover me-3">
            <thead>
                <th colspan="2">Ventas del día: {{ time|date }}</th>
            </thead>
            {% for key,value in sales_day.items %}
                <tr>
                    <td>{{ key }}</td>
                    {% for sub_key, sub_value in value.items %}
                        {% if not sub_value %}
                            <td>$0</td>
                        {% else %}
                            <td>${{ sub_value|intcomma }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
        <table class="table table-hover ms-3">
            <thead>
                <th colspan="2">Ventas del Mes</th>
            </thead>
            {% for key,value in sales_month.items %}
                <tr style="height:10px">
                    <td>{{ key }}</td>
                    {% for sub_key, sub_value in value.items %}
                        {% if not sub_value %}
                            <td>$0</td>
                        {% else %}
                            <td>${{ sub_value|intcomma }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
        <table class="table table-hover ms-3">
            <thead>
                <th colspan="2">Clientes Nuevos por día Mexico</th>
            </thead>
            <tr style="height:10px">
                {% for key, value in sales_per_day_new_user.items %}
                    <tr>
                        <form>
                            <td>
                                <input name="date" type="date" class="form-control" value={{ key }}>
                            </td>
                            <td>
                                <input type="submit" value="buscar" class="btn btn-success">
                            </td>
                            <form>
                            </tr>
                            <tr>
                                <td>Venta Total</td>
                                <td>${{ value.sales|intcomma }}</td>
                            </tr>
                            <tr>
                                <td>Cantidad de Clientes Mexico</td>
                                <td>{{ value.new_users }}</td>
                            </tr>
                        {% endfor %}
                    </tr>
                </table>
            </div>
            <div style="width:400px">
                <canvas id="myChart" class="lex-shrink-0"></canvas>
                <h3>Ventas totales a clientes nuevos Mexico</h3>
                <canvas id="graficoBarras" width="400" height="300"></canvas>
                <h3>Cantidad de clientes nuevos Mexico</h3>
                <canvas id="graficoBarras2" width="400" height="300"></canvas>
            </div>

            <hr class="my-4">

            <!-- NUEVAS ESTADÍSTICAS DE VISITAS -->
            <h2 class="mb-4">Estadísticas de Visitas</h2>
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Visitantes Únicos Hoy</h5>
                            <p class="card-text display-6">{{ unique_visitors.unique_ips }}</p>
                            <small class="text-muted">Por IP</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <table class="table table-hover">
                        <thead>
                            <th colspan="2">Visitas por Página - Hoy</th>
                        </thead>
                        {% for page, count in page_visits_today.items %}
                        <tr>
                            <td>{{ page }}</td>
                            <td>{{ count }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="2">No hay visitas registradas hoy</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <table class="table table-hover">
                        <thead>
                            <th colspan="2">Visitas Totales por Página</th>
                        </thead>
                        {% for page, count in page_visits_total.items %}
                        <tr>
                            <td>{{ page }}</td>
                            <td>{{ count }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="2">No hay visitas registradas</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                <div class="col-md-6">
                    <canvas id="pageVisitsChart" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <h4>Visitas de los últimos 30 días</h4>
                    <canvas id="visitsLineChart" width="800" height="200"></canvas>
                </div>
            </div>

            <hr class="my-4">

            <!-- NUEVAS ESTADÍSTICAS DE VENTAS WEB -->
            <h2 class="mb-4">Estadísticas de Ventas Web</h2>
            <p class="text-muted mb-3">Haz clic en cada tarjeta para ver el detalle completo</p>
            <div class="row mb-4">
                <div class="col-md-3">
                    <a href="{% url 'adm:web_sales_today_detail' %}" class="text-decoration-none">
                        <div class="card bg-primary text-white clickable-card">
                            <div class="card-body">
                                <h5 class="card-title">Ventas Web Hoy</h5>
                                <p class="card-text display-6">${{ web_sales_today.total|intcomma }}</p>
                                <small>{{ web_sales_today.count }} ventas</small>
                                <div class="mt-2">
                                    <i class="bi bi-eye"></i> Ver detalle
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'adm:web_sales_weekly_detail' %}" class="text-decoration-none">
                        <div class="card bg-success text-white clickable-card">
                            <div class="card-body">
                                <h5 class="card-title">Esta Semana</h5>
                                <p class="card-text display-6">${{ web_sales_weekly.total|intcomma }}</p>
                                <small>{{ web_sales_weekly.count }} ventas</small>
                                <div class="mt-2">
                                    <i class="bi bi-eye"></i> Ver detalle
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'adm:web_sales_monthly_detail' %}" class="text-decoration-none">
                        <div class="card bg-info text-white clickable-card">
                            <div class="card-body">
                                <h5 class="card-title">Este Mes</h5>
                                <p class="card-text display-6">${{ web_sales_monthly.total|intcomma }}</p>
                                <small>{{ web_sales_monthly.count }} ventas</small>
                                <div class="mt-2">
                                    <i class="bi bi-eye"></i> Ver detalle
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'adm:web_sales_yearly_detail' %}" class="text-decoration-none">
                        <div class="card bg-warning text-dark clickable-card">
                            <div class="card-body">
                                <h5 class="card-title">Este Año</h5>
                                <p class="card-text display-6">${{ web_sales_yearly.total|intcomma }}</p>
                                <small>{{ web_sales_yearly.count }} ventas</small>
                                <div class="mt-2">
                                    <i class="bi bi-eye"></i> Ver detalle
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <h4>Ventas Web - Últimos 12 meses</h4>
                    <canvas id="webSalesChart" width="800" height="300"></canvas>
                </div>
            </div>

        {% endblock body %}
        {% block extrajs %}
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
        const ctx = document.getElementById('myChart');
        const data = {
            labels: {{acc_name|safe}},
            datasets: [{
            label: 'Total',
            data: {{acc_total|safe}},
            backgroundColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)'
            ],
            hoverOffset: 40
            }]
        };
        const options = {
            plugins: {
                title: {
                    display: true,
                    text: 'Cuentas Vendidas en el Mes'
                }
            }
        }
        const config = {
        type: 'doughnut',
        data: data,
        options: options
        };

        new Chart(ctx, config);
            </script>
            <script>
        // Definimos los datos para las etiquetas y las barras
        const meses = []
        const datos = [];
        {% for item in last_year_sales_new_user %}
            meses.push("{{ item.date }}");
            datos.push("{{ item.sales }}");
        {% endfor %}
        meses.reverse()
        datos.reverse()
        
        // Obtenemos el elemento canvas donde se mostrará el gráfico
        const canvasBarras = document.getElementById("graficoBarras");
        
        // Creamos el gráfico de barras
        new Chart(canvasBarras, {
          type: "bar",
          data: {
            labels: meses,
            datasets: [{
              label: "Ventas",
              data: datos
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              title: {
                display: true,
                text: "Ventas a clientes nuevos"
              }
            }
          }
        });

        // Definimos los datos para las etiquetas y las barras
        const meses2 = []
        const datos2 = [];
        {% for item in last_year_sales_new_user %}
            meses2.push("{{ item.date }}");
            datos2.push("{{ item.new_users }}");
        {% endfor %}
        meses2.reverse()
        datos2.reverse()
        
        // Obtenemos el elemento canvas donde se mostrará el gráfico
        const canvasBarras2 = document.getElementById("graficoBarras2");
        
        // Creamos el segundo gráfico de barras
        new Chart(canvasBarras2, {
          type: "bar",
          data: {
            labels: meses2,
            datasets: [{
              label: "Ventas",
              data: datos2
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            },
            plugins: {
              title: {
                display: true,
                text: "Clientes nuevos por mes"
              }
            }
          }
        });
            </script>

            <!-- Gráfico de Visitas por Página (Pie/Doughnut) -->
            <script>
        const pageVisitsCtx = document.getElementById('pageVisitsChart');
        const pageVisitsLabels = [];
        const pageVisitsData = [];

        {% for page, count in page_visits_7days.items %}
            pageVisitsLabels.push("{{ page }}");
            pageVisitsData.push({{ count }});
        {% endfor %}

        const pageVisitsChartConfig = {
            type: 'doughnut',
            data: {
                labels: pageVisitsLabels,
                datasets: [{
                    label: 'Visitas',
                    data: pageVisitsData,
                    backgroundColor: [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)',
                        'rgb(75, 192, 192)',
                        'rgb(153, 102, 255)',
                        'rgb(255, 159, 64)'
                    ],
                    hoverOffset: 40
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Visitas por Página - Últimos 7 días'
                    }
                }
            }
        };

        new Chart(pageVisitsCtx, pageVisitsChartConfig);
            </script>

            <!-- Gráfico de Líneas - Visitas últimos 30 días -->
            <script>
        const visitsLineCtx = document.getElementById('visitsLineChart');
        const visitsLineDates = [];
        const visitsLineData = [];

        {% for item in visits_chart_data %}
            visitsLineDates.push("{{ item.date }}");
            visitsLineData.push({{ item.visits }});
        {% endfor %}

        const visitsLineChartConfig = {
            type: 'line',
            data: {
                labels: visitsLineDates,
                datasets: [{
                    label: 'Visitas',
                    data: visitsLineData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Evolución de Visitas - Últimos 30 días'
                    }
                }
            }
        };

        new Chart(visitsLineCtx, visitsLineChartConfig);
            </script>

            <!-- Gráfico de Ventas Web - Últimos 12 meses -->
            <script>
        const webSalesCtx = document.getElementById('webSalesChart');
        const webSalesMonths = [];
        const webSalesTotals = [];

        {% for item in web_sales_chart %}
            webSalesMonths.push("{{ item.month }} {{ item.year }}");
            webSalesTotals.push({{ item.total }});
        {% endfor %}

        const webSalesChartConfig = {
            type: 'bar',
            data: {
                labels: webSalesMonths,
                datasets: [{
                    label: 'Ventas Web ($)',
                    data: webSalesTotals,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Ventas Web Mensuales - Últimos 12 meses'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Total: $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        };

        new Chart(webSalesCtx, webSalesChartConfig);
            </script>
        {% endblock extrajs %}
