{% extends 'adm/base/base.html' %}
{% load static %}
{% load pagination_filters %}
{% block title %}
    Ventas
{% endblock title %}
{% block head %}
    <script async
            src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1307198861567997"
            crossorigin="anonymous"></script>
{% endblock head %}
{% block body %}
<div class="container-fluid py-4">
    <!-- Available Accounts Info - Small Cards -->
    {% if availables %}
        <div class="row g-2 mb-4">
            {% for key, value in availables.items %}
                <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body p-2 text-center">
                            <small class="text-muted d-block">{{ key }}</small>
                            <h5 class="card-title mb-0" style="color: #0d6efd;">{{ value }}</h5>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Header -->
    <div class="mb-4">
        {% if customer.username or customer.email or customer.userdetail.phone_number %}
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col">
                            <h3 class="card-title mb-3">
                                <i class="bi bi-receipt me-2" style="color: #0d6efd;"></i>
                                {% if customer.username %}
                                    Ventas a {{ customer.username }}
                                {% elif customer.email %}
                                    Ventas a {{ customer.email }}
                                {% else %}
                                    Ventas a {{ customer.userdetail.phone_number }}
                                {% endif %}
                            </h3>
                            <!-- Customer Info Grid -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div style="background: #e7f3ff; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" class="me-3">
                                            <i class="bi bi-person" style="color: #0d6efd; font-size: 20px;"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block">Usuario</small>
                                            <strong>{{ customer.username }}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div style="background: #fff3e0; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" class="me-3">
                                            <i class="bi bi-envelope" style="color: #ff9800; font-size: 20px;"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block">Email</small>
                                            <strong>{{ customer.email }}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div style="background: #f3e5f5; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" class="me-3">
                                            <i class="bi bi-telephone" style="color: #9c27b0; font-size: 20px;"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block">Tel√©fono</small>
                                            <strong>{{ customer.userdetail.phone_number }}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div style="background: #e8f5e9; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" class="me-3">
                                            <i class="bi bi-globe" style="color: #4caf50; font-size: 20px;"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted d-block">Pa√≠s</small>
                                            <strong>{{ customer.userdetail.country }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="btn-group-vertical" role="group">
                                <a href="{% url 'adm:user_mainupdate' customer.id %}" class="btn btn-sm btn-outline-secondary" title="Datos personales">
                                    <i class="bi bi-person-gear me-2"></i> Datos Personales
                                </a>
                                <a href="{% url 'adm:user_change_phone' customer.id %}" class="btn btn-sm btn-outline-secondary" title="Cambiar tel√©fono">
                                    <i class="bi bi-telephone-fill me-2"></i> Cambiar Tel√©fono
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <h3 class="mb-0">
                <i class="bi bi-receipt me-2" style="color: #0d6efd;"></i>
                Ventas
            </h3>
        {% endif %}
    </div>

    <!-- Free Days Alert -->
    {% if customer.userdetail.free_days > 0 %}
        <div class="alert alert-success alert-dismissible fade show d-flex align-items-center mb-4" role="alert">
            <i class="bi bi-gift-fill me-3" style="font-size: 24px;"></i>
            <div>
                <strong>¬°Felicidades!</strong>
                <p class="mb-0">Tienes <span class="badge bg-success">{{ customer.userdetail.free_days }} d√≠as gratis</span> para utilizar en la compra de servicios.</p>
            </div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}

    <!-- Search & Action Bar -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-3">
            <form method="post" action="{% url 'adm:sales' %}">
                {% csrf_token %}
                <div class="row g-2">
                    <div class="col-12 col-md-6">
                        <input type="text"
                               id="customer-search-input"
                               class="form-control form-control-lg"
                               name="customer"
                               placeholder="Buscar por email o tel√©fono..."
                               autofocus
                               style="border-radius: 8px;">
                    </div>
                    <div class="col-12 col-md-auto d-flex flex-wrap gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" style="border-radius: 8px;">
                            <i class="bi bi-search me-2"></i> Buscar
                        </button>
                        <button type="button" id="paste-customer-btn" class="btn btn-outline-primary btn-lg" style="border-radius: 8px;">
                            <i class="bi bi-clipboard me-2"></i> Pegar
                        </button>
                        <a href="{% url 'adm:sales' %}" class="btn btn-outline-secondary btn-lg" style="border-radius: 8px;">
                            <i class="bi bi-x-lg me-2"></i> Limpiar
                        </a>
                        {% if customer and customer.userdetail.country %}
                            {% if customer.userdetail.country != '??' %}
                                <a href="{% url 'adm:sales_create' customer.id %}" class="btn btn-success btn-lg" style="border-radius: 8px;" title="Crear nueva venta">
                                    <i class="bi bi-plus-circle me-2"></i> Nueva Venta
                                </a>
                                <button type="button" class="btn btn-info btn-lg" style="border-radius: 8px;" data-bs-toggle="modal" data-bs-target="#staticBackdrop" title="Canjear c√≥digo">
                                    <i class="bi bi-ticket-perforated me-2"></i> Canjear C√≥digo
                                </button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Country Alert -->
    {% if customer and not customer.userdetail.country or customer.userdetail.country == '??' %}
        <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 20px;"></i>
            <div>
                <strong>Perfil Incompleto</strong>
                <p class="mb-0">Para crear ventas, debes completar el perfil. <a href="{% url 'adm:user_update' customer.userdetail.id %}" class="alert-link fw-bold">Completar perfil ‚Üí</a></p>
            </div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}

    <!-- Error Message -->
    {% if message %}
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-circle-fill me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}
    {% if customer %}
        <!-- Active Accounts Section -->
        <div class="mb-5">
            <div class="d-flex align-items-center mb-3">
                <h5 class="mb-0">
                    <span class="badge bg-success me-2">
                        <i class="bi bi-check-circle me-1"></i>
                        Activas ({{ active|length }})
                    </span>
                </h5>
            </div>

            {% if active %}
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" style="width: 50px;"><i class="bi bi-image"></i></th>
                                <th class="text-center" style="width: 50px;"></th>
                                <th>E-Mail</th>
                                <th>Clave</th>
                                <th>Pin</th>
                                <th>Perfil</th>
                                <th>F. Compra</th>
                                <th>F. Vencimiento</th>
                                <th>F. Vencimiento Cuenta</th>
                                <th>Estado Externo</th>
                                <th>Vendedor</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in active %}
                                <tr class="align-middle">
                                    <td class="text-center">
                                        <img src="{{ a.account.account_name.logo.url }}"
                                             alt="{{ a.account.account_name.description }}"
                                             width="35"
                                             height="35"
                                             style="object-fit: contain;">
                                    </td>
                                    <td class="text-center">
                                        {% if a.account.renovable %}
                                            <i class="bi bi-star-fill" style="color: #ffc107; font-size: 18px;" title="Renovable"></i>
                                        {% endif %}
                                        <textarea id="{{a.id}}" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;opacity:0;pointer-events:none;" tabindex="-1" aria-hidden="true" readonly>
*E-Mail:* {{a.account.email}}
*Clave:* {{a.account.password}}  
*Perfil:* {{a.account.profile}}

üíé Esta es su cuenta *{{a.account.account_name.description}}* para *1 Dispositivo*.
Inicie sesi√≥n con el *EMAIL* y *CLAVE* recibidos.

‚Ä¢ Usar *SOLO EL PERFIL ASIGNADO*
‚Ä¢ *NO* puedes cambiar las claves.

Gracias por tu preferencia.
Recuerda que los √∫nicos canales oficiales de atenci√≥n son:
WhatsApp y Telegram al n√∫mero 833 535 5863.
                                        </textarea>
                                        <textarea id="{{a.id}}2" style="border:none;background-color:transparent;overflow: hidden;resize: none;" rows="1" cols="1" readonly>
                            *Muchas Gracias por tu compra!*
                            Para ver tus claves siempre actualizadas descarga nuestra app *Cuentas Mexico* desde Play store haciendo click aqui: https://play.google.com/store/apps/details?id=com.luinmack.CuentasMexicoApp
                            Tambien verlas desde Iphone, Ipad o PC en https://app.cuentasmexico.com
                            Tus usuario para la aplicacion es:
                            *{{a.customer.username}}*
                            Preguntame por la clave si no la tienes o no la recuerdas.
                                        </textarea>
                                    </td>
                                    <td>
                                        <span style="cursor:pointer; text-decoration:underline; color:#0d6efd; font-weight: 500;"
                                              onclick="copyAcc('{{ a.id }}')"
                                              title="Click para copiar claves">
                                            {{ a.account.email }}
                                        </span>
                                    </td>
                                    <td>
                                        <code style="background-color: #f0f0f0; padding: 4px 8px; border-radius: 4px;">
                                            {{ a.account.password }}
                                        </code>
                                    </td>
                                    <td>
                                        <code style="background-color: #f0f0f0; padding: 4px 8px; border-radius: 4px;">
                                            {{ a.account.pin }}
                                        </code>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ a.account.profile }}</span>
                                    </td>
                                    <td class="text-nowrap">{{ a.created_at|date:'d/m/Y' }}</td>
                                    <td class="text-nowrap">{{ a.expiration_date|date:'d/m/Y' }}</td>
                                    <td class="text-nowrap">{{ a.account.expiration_date|date:'d/m/Y' }}</td>
                                    <td>
                                        {% if a.account.external_status == 'Disponible' %}
                                            <span class="badge bg-success">{{ a.account.external_status }}</span>
                                        {% elif a.account.external_status == 'No Disponible' %}
                                            <span class="badge bg-danger">{{ a.account.external_status }}</span>
                                        {% elif a.account.external_status == 'Suspendida' %}
                                            <span class="badge bg-secondary">{{ a.account.external_status }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ a.account.external_status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ a.user_seller }}</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-info"
                                                    onclick="getHomeCode('{{ a.account.email }}')"
                                                    title="Obtener C√≥digo Hogar"
                                                    type="button">
                                                <i class="bi bi-key"></i>
                                            </button>
                                            <a href="{% url 'adm:sales_update_status' a.id a.customer.id a.status %}"
                                               title="Suspender"
                                               class="btn btn-outline-warning">
                                                <i class="bi bi-stop-circle"></i>
                                            </a>
                                            <a href="{% url 'adm:sales_renew' a.id %}" title="Renovar" class="btn btn-outline-success">
                                                <i class="bi bi-arrow-clockwise"></i>
                                            </a>
                                            <a href="{% url 'adm:sales_change' a.id %}" title="Cambiar Cuenta" class="btn btn-outline-primary">
                                                <i class="bi bi-shuffle"></i>
                                            </a>
                                            <a href="#"
                                               onclick="abrir_modal_edicion('{% url 'adm:key_adjust' a.id %}')"
                                               title="Ajustar Vencimiento"
                                               class="btn btn-outline-secondary">
                                                <i class="bi bi-calendar-event"></i>
                                            </a>
                                            <a href="#"
                                               onclick="copyAcc('{{ a.id }}')"
                                               title="Copiar Claves"
                                               class="btn btn-outline-dark">
                                                <i class="bi bi-clipboard"></i>
                                            </a>
                                            <a href="#"
                                               onclick="copyAcc('{{ a.id }}2')"
                                               title="Entregar Links"
                                               class="btn btn-outline-success">
                                                <i class="bi bi-clipboard2-heart"></i>
                                            </a>
                                            {% if customer.userdetail.free_days > 0 %}
                                                <a href="{% url 'adm:sales_add_free_days' a.id customer.userdetail.free_days %}"
                                                   title="Agregar {{ customer.userdetail.free_days }} d√≠as gratis"
                                                   class="btn btn-outline-success">
                                                    <i class="bi bi-gift-fill"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                        </tr>
                    {% endfor %}
                </tbody>
                    </table>
                </div>

                <div class="d-md-none sales-mobile-list">
                    {% for a in active %}
                        <article class="sales-mobile-card sales-mobile-card-copy"
                                 onclick="copyAcc('{{ a.id }}')"
                                 onkeydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); copyAcc('{{ a.id }}'); }"
                                 role="button"
                                 tabindex="0"
                                 title="Toca para copiar claves">
                            <div class="sales-mobile-header">
                                <div class="d-flex align-items-center gap-2">
                                    <img src="{{ a.account.account_name.logo.url }}"
                                         alt="{{ a.account.account_name.description }}"
                                         width="36"
                                         height="36"
                                         style="object-fit: contain;">
                                    <div>
                                        <strong class="d-block">{{ a.account.account_name.description }}</strong>
                                        {% if a.account.renovable %}
                                            <small class="text-warning"><i class="bi bi-star-fill me-1"></i>Renovable</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <span class="badge bg-success">Activa</span>
                            </div>
                            <div class="sales-mobile-grid">
                                <div><small>Email</small><span>{{ a.account.email }}</span></div>
                                <div><small>Clave</small><code>{{ a.account.password }}</code></div>
                                <div><small>Pin</small><code>{{ a.account.pin }}</code></div>
                                <div><small>Perfil</small><span class="badge bg-info">{{ a.account.profile }}</span></div>
                                <div><small>F. Compra</small><span>{{ a.created_at|date:'d/m/Y' }}</span></div>
                                <div><small>F. Vencimiento</small><span>{{ a.expiration_date|date:'d/m/Y' }}</span></div>
                                <div><small>F. V. Cuenta</small><span>{{ a.account.expiration_date|date:'d/m/Y' }}</span></div>
                                <div>
                                    <small>Estado Externo</small>
                                    <span>
                                        {% if a.account.external_status == 'Disponible' %}
                                            <span class="badge bg-success">{{ a.account.external_status }}</span>
                                        {% elif a.account.external_status == 'No Disponible' %}
                                            <span class="badge bg-danger">{{ a.account.external_status }}</span>
                                        {% elif a.account.external_status == 'Suspendida' %}
                                            <span class="badge bg-secondary">{{ a.account.external_status }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ a.account.external_status }}</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div><small>Vendedor</small><span>{{ a.user_seller }}</span></div>
                            </div>
                            <div class="sales-mobile-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-outline-info btn-sm"
                                        onclick="getHomeCode('{{ a.account.email }}')"
                                        title="Obtener C√≥digo Hogar"
                                        type="button">
                                    <i class="bi bi-key"></i>
                                </button>
                                <a href="{% url 'adm:sales_update_status' a.id a.customer.id a.status %}"
                                   title="Suspender"
                                   class="btn btn-outline-warning btn-sm">
                                    <i class="bi bi-stop-circle"></i>
                                </a>
                                <a href="{% url 'adm:sales_renew' a.id %}" title="Renovar" class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </a>
                                <a href="{% url 'adm:sales_change' a.id %}" title="Cambiar Cuenta" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-shuffle"></i>
                                </a>
                                <a href="#"
                                   onclick="abrir_modal_edicion('{% url 'adm:key_adjust' a.id %}')"
                                   title="Ajustar Vencimiento"
                                   class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-calendar-event"></i>
                                </a>
                                <a href="#"
                                   onclick="copyAcc('{{ a.id }}')"
                                   title="Copiar Claves"
                                   class="btn btn-outline-dark btn-sm">
                                    <i class="bi bi-clipboard"></i>
                                </a>
                                <a href="#"
                                   onclick="copyAcc('{{ a.id }}2')"
                                   title="Entregar Links"
                                   class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-clipboard2-heart"></i>
                                </a>
                                {% if customer.userdetail.free_days > 0 %}
                                    <a href="{% url 'adm:sales_add_free_days' a.id customer.userdetail.free_days %}"
                                       title="Agregar {{ customer.userdetail.free_days }} d√≠as gratis"
                                       class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-gift-fill"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </article>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info mb-0" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    No hay cuentas activas disponibles
                </div>
            {% endif %}
        </div>

        <!-- Inactive Accounts Section -->
        {% if inactive %}
            <div class="mb-5">
                <div class="d-flex align-items-center mb-3">
                    <h5 class="mb-0">
                        <span class="badge bg-danger me-2">
                            <i class="bi bi-x-circle me-1"></i>
                            Inactivas ({{ inactive.paginator.count }})
                        </span>
                    </h5>
                </div>

                <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" style="width: 50px;"><i class="bi bi-image"></i></th>
                                <th class="text-center" style="width: 50px;"></th>
                                <th>E-Mail</th>
                                <th>Clave</th>
                                <th>Pin</th>
                                <th>Perfil</th>
                                <th>F. Compra</th>
                                <th>F. Vencimiento Cliente</th>
                                <th>F. Vencimiento Cuenta</th>
                                <th>Estado Externo</th>
                                <th>Vendedor</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in inactive %}
                                <tr class="align-middle">
                                    <td class="text-center">
                                        <img src="{{ a.account.account_name.logo.url }}"
                                             alt="{{ a.account.account_name.description }}"
                                             width="35"
                                             height="35"
                                             style="object-fit: contain;">
                                    </td>
                                    <td class="text-center">
                                        {% if a.account.renovable %}
                                            <i class="bi bi-star-fill" style="color: #ffc107; font-size: 18px;" title="Renovable"></i>
                                        {% endif %}
                                    </td>
                                    <td>{{ a.account.email }}</td>
                                    <td>
                                        <code style="background-color: #f0f0f0; padding: 4px 8px; border-radius: 4px;">
                                            {{ a.account.password }}
                                        </code>
                                    </td>
                                    <td>
                                        <code style="background-color: #f0f0f0; padding: 4px 8px; border-radius: 4px;">
                                            {{ a.account.pin }}
                                        </code>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ a.account.profile }}</span>
                                    </td>
                                    <td class="text-nowrap">{{ a.created_at|date:'d/m/Y' }}</td>
                                    <td class="text-nowrap">{{ a.expiration_date|date:'d/m/Y' }}</td>
                                    <td class="text-nowrap">{{ a.account.expiration_date|date:'d/m/Y' }}</td>
                                    <td>
                                        {% if a.account.external_status == 'Disponible' %}
                                            <span class="badge bg-success">{{ a.account.external_status }}</span>
                                        {% elif a.account.external_status == 'No Disponible' %}
                                            <span class="badge bg-danger">{{ a.account.external_status }}</span>
                                        {% elif a.account.external_status == 'Suspendida' %}
                                            <span class="badge bg-secondary">{{ a.account.external_status }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ a.account.external_status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ a.user_seller }}</td>
                                    <td class="text-center">
                                        {% if a.old_acc %}
                                            <a href="#"
                                               onclick="abrir_modal_edicion('{% url 'adm:sales_old' a.id %}')"
                                               title="Ver Hist√≥rico"
                                               class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-archive"></i>
                                            </a>
                                        {% else %}
                                            <span class="text-muted small">‚Äî</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-md-none sales-mobile-list">
                    {% for a in inactive %}
                        <article class="sales-mobile-card sales-mobile-card-inactive">
                            <div class="sales-mobile-header">
                                <div class="d-flex align-items-center gap-2">
                                    <img src="{{ a.account.account_name.logo.url }}"
                                         alt="{{ a.account.account_name.description }}"
                                         width="36"
                                         height="36"
                                         style="object-fit: contain;">
                                    <div>
                                        <strong class="d-block">{{ a.account.account_name.description }}</strong>
                                        {% if a.account.renovable %}
                                            <small class="text-warning"><i class="bi bi-star-fill me-1"></i>Renovable</small>
                                        {% endif %}
                                    </div>
                                </div>
                                <span class="badge bg-danger">Inactiva</span>
                            </div>
                            <div class="sales-mobile-grid">
                                <div><small>Email</small><span>{{ a.account.email }}</span></div>
                                <div><small>Clave</small><code>{{ a.account.password }}</code></div>
                                <div><small>Pin</small><code>{{ a.account.pin }}</code></div>
                                <div><small>Perfil</small><span class="badge bg-secondary">{{ a.account.profile }}</span></div>
                                <div><small>F. Compra</small><span>{{ a.created_at|date:'d/m/Y' }}</span></div>
                                <div><small>F. V. Cliente</small><span>{{ a.expiration_date|date:'d/m/Y' }}</span></div>
                                <div><small>F. V. Cuenta</small><span>{{ a.account.expiration_date|date:'d/m/Y' }}</span></div>
                                <div>
                                    <small>Estado Externo</small>
                                    <span>
                                        {% if a.account.external_status == 'Disponible' %}
                                            <span class="badge bg-success">{{ a.account.external_status }}</span>
                                        {% elif a.account.external_status == 'No Disponible' %}
                                            <span class="badge bg-danger">{{ a.account.external_status }}</span>
                                        {% elif a.account.external_status == 'Suspendida' %}
                                            <span class="badge bg-secondary">{{ a.account.external_status }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ a.account.external_status }}</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div><small>Vendedor</small><span>{{ a.user_seller }}</span></div>
                            </div>
                            <div class="sales-mobile-actions">
                                {% if a.old_acc %}
                                    <a href="#"
                                       onclick="abrir_modal_edicion('{% url 'adm:sales_old' a.id %}')"
                                       title="Ver Hist√≥rico"
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-archive"></i>
                                    </a>
                                {% else %}
                                    <span class="text-muted small">Sin hist√≥rico</span>
                                {% endif %}
                            </div>
                        </article>
                    {% endfor %}
                </div>

                <!-- Pagination for Inactive Accounts -->
                {% if inactive.has_other_pages %}
                    <nav aria-label="Paginaci√≥n de cuentas inactivas" class="mt-3">
                        <ul class="pagination justify-content-center mb-0">
                            {% if inactive.has_previous %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?inactive_page=1{% if customer %}&customer={{ customer.id }}{% endif %}">&laquo; Primera</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?inactive_page={{ inactive.previous_page_number }}{% if customer %}&customer={{ customer.id }}{% endif %}">Anterior</a>
                                </li>
                            {% endif %}
                            {% for num in inactive.paginator.page_range %}
                                {% if num == inactive.number %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > inactive.number|add:-3 and num < inactive.number|add:3 %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="?inactive_page={{ num }}{% if customer %}&customer={{ customer.id }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            {% if inactive.has_next %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?inactive_page={{ inactive.next_page_number }}{% if customer %}&customer={{ customer.id }}{% endif %}">Siguiente</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?inactive_page={{ inactive.paginator.num_pages }}{% if customer %}&customer={{ customer.id }}{% endif %}">√öltima &raquo;</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        {% endif %}
    {% endif %}

<!-- Coupon Redemption Modal -->
<div class="modal fade"
     id="staticBackdrop"
     data-bs-backdrop="static"
     data-bs-keyboard="false"
     tabindex="-1"
     aria-labelledby="staticBackdropLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <form action="{% url 'adm:cupon_redeem' %}" method="post">
                {% csrf_token %}
                <div class="modal-header bg-light border-bottom">
                    <h5 class="modal-title" id="staticBackdropLabel">
                        <i class="bi bi-ticket-perforated me-2" style="color: #0d6efd;"></i>
                        Canjear C√≥digo
                    </h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-muted mb-3">Ingresa el c√≥digo del cup√≥n para <strong>{{ customer.username }}</strong></p>
                    <label for="code" class="form-label fw-bold">C√≥digo del Cup√≥n</label>
                    <input type="text" 
                           id="code" 
                           name="code" 
                           class="form-control form-control-lg"
                           placeholder="Ej: ABC123XYZ"
                           autofocus
                           style="border-radius: 8px;">
                    <input type="hidden" name="customer" value="{{ customer.id }}">
                </div>
                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i> Canjear
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Home Code Modal -->
<div class="modal fade" id="homeCodeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header bg-light border-bottom">
                <h5 class="modal-title">
                    <i class="bi bi-key me-2" style="color: #0d6efd;"></i>
                    C√≥digo Hogar
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div id="homeCodeContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3 text-muted">Buscando c√≥digo hogar...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-top">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="copyHomeCode()">
                    <i class="bi bi-clipboard me-2"></i> Copiar C√≥digo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>

</div><!-- End container-fluid -->

{% endblock body %}

{% block extrajs %}
    <script src="{% static 'adm/js/copy.js' %}"></script>
    <script>
        let currentHomeCode = '';
        let homeCodeInterval = null;
        let homeCodeRetries = 0;
        const MAX_RETRIES = 30; // M√°ximo 30 reintentos (5 minutos a 10 segundos cada uno)
        const RETRY_INTERVAL = 10000; // 10 segundos entre reintentos

        // Funci√≥n para mostrar notificaciones toast
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg mb-2`;
            toast.style.cssText = 'min-width: 250px; animation: slideIn 0.3s ease-out;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span>${message}</span>
                </div>
            `;

            toastContainer.appendChild(toast);

            // Remover el toast despu√©s de 3 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Agregar estilos de animaci√≥n
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        function fetchHomeCode(email) {
            const url = `https://servertools.bdpyc.cl/api/home-codes-public/active/${encodeURIComponent(email)}`;
            console.log('Fetching home code from:', url);

            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    console.log('Inner data:', data.data);

                    // Funci√≥n para formatear la fecha
                    function formatEmailDate(emailDateString) {
                        if (!emailDateString) return 'Fecha no disponible';

                        // Extraer la fecha del formato "Date: Sun, 18 Jan 2026 19:31:39 +0000"
                        const dateMatch = emailDateString.match(/Date:\s*(.+)/);
                        if (!dateMatch) return emailDateString;

                        try {
                            const date = new Date(dateMatch[1]);
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const year = date.getFullYear();
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            const seconds = String(date.getSeconds()).padStart(2, '0');

                            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
                        } catch (e) {
                            return emailDateString;
                        }
                    }

                    // Extraer y ordenar todos los c√≥digos por fecha
                    let codesData = [];
                    if (data.data?.codes && data.data.codes.length > 0) {
                        codesData = data.data.codes
                            .map(c => ({
                                codigo: c.codigo || c.homeCode || c.code,
                                email_date: c.email_date,
                                subject: c.subject,
                                rawDate: c.email_date ? new Date(c.email_date.replace('Date: ', '')) : new Date(0)
                            }))
                            .filter(c => c.codigo)
                            .sort((a, b) => b.rawDate - a.rawDate); // Ordenar de m√°s reciente a m√°s antiguo
                    }

                    console.log('Extracted and sorted codes:', codesData);

                    if (codesData.length > 0 && codesData[0].codigo !== 'No disponible') {
                        // C√≥digos obtenidos exitosamente
                        currentHomeCode = codesData[0].codigo;

                        // Generar HTML para todos los c√≥digos
                        const codesHTML = codesData.map((codeData, index) =>
                            `<div class="mb-3 p-3 border rounded bg-light">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>C√≥digo ${index + 1}:</strong>
                                        <code class="bg-white p-2 rounded d-inline-block">${codeData.codigo}</code>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <small class="text-muted">
                                            <strong>Fecha:</strong> ${formatEmailDate(codeData.email_date)}
                                        </small>
                                    </div>
                                </div>
                                ${codeData.subject ? `<div class="mt-2"><small><strong>Asunto:</strong> ${codeData.subject}</small></div>` : ''}
                            </div>`
                        ).join('');

                        document.getElementById('homeCodeContent').innerHTML = `
                            <div class="alert alert-success">
                                <strong>Email:</strong> ${email}<br>
                                <strong>Total de c√≥digos:</strong> ${codesData.length}<br><br>
                                ${codesHTML}
                            </div>
                        `;
                        // Detener el polling
                        if (homeCodeInterval) {
                            clearInterval(homeCodeInterval);
                            homeCodeInterval = null;
                        }
                    } else if (homeCodeRetries < MAX_RETRIES) {
                        // C√≥digo no disponible a√∫n, mostrar spinner y esperar
                        homeCodeRetries++;
                        document.getElementById('homeCodeContent').innerHTML = `
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2"><small>Buscando c√≥digo hogar... (Intento ${homeCodeRetries}/${MAX_RETRIES})</small></p>
                            </div>
                        `;
                    } else {
                        // M√°ximo de reintentos alcanzado
                        document.getElementById('homeCodeContent').innerHTML = `
                            <div class="alert alert-warning">
                                <strong>C√≥digo no disponible</strong><br>
                                <small>Se alcanz√≥ el n√∫mero m√°ximo de intentos. El c√≥digo hogar a√∫n no est√° disponible.</small>
                            </div>
                        `;
                        if (homeCodeInterval) {
                            clearInterval(homeCodeInterval);
                            homeCodeInterval = null;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching home code:', error);
                    if (homeCodeRetries < MAX_RETRIES) {
                        homeCodeRetries++;
                        document.getElementById('homeCodeContent').innerHTML = `
                            <div class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2"><small class="text-danger">Error de conexi√≥n. Reintentando... (Intento ${homeCodeRetries}/${MAX_RETRIES})</small></p>
                            </div>
                        `;
                    } else {
                        document.getElementById('homeCodeContent').innerHTML = `
                            <div class="alert alert-danger">
                                <strong>Error al obtener el c√≥digo hogar</strong><br>
                                <small>${error.message}</small>
                            </div>
                        `;
                        if (homeCodeInterval) {
                            clearInterval(homeCodeInterval);
                            homeCodeInterval = null;
                        }
                    }
                });
        }

        function getHomeCode(email) {
            // Reiniciar variables
            currentHomeCode = '';
            homeCodeRetries = 0;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('homeCodeModal'));
            modal.show();
            
            // Mostrar spinner inicial
            document.getElementById('homeCodeContent').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2"><small>Buscando c√≥digo hogar...</small></p>
                </div>
            `;
            
            // Primer intento
            fetchHomeCode(email);
            
            // Establecer intervalo para reintentos
            if (!homeCodeInterval) {
                homeCodeInterval = setInterval(() => {
                    if (homeCodeRetries < MAX_RETRIES && !currentHomeCode) {
                        fetchHomeCode(email);
                    } else if (currentHomeCode || homeCodeRetries >= MAX_RETRIES) {
                        clearInterval(homeCodeInterval);
                        homeCodeInterval = null;
                    }
                }, RETRY_INTERVAL);
            }
            
            // Limpiar intervalo cuando se cierra el modal
            document.getElementById('homeCodeModal').addEventListener('hidden.bs.modal', function() {
                if (homeCodeInterval) {
                    clearInterval(homeCodeInterval);
                    homeCodeInterval = null;
                }
            }, { once: true });
        }

        function copyHomeCode() {
            if (currentHomeCode && currentHomeCode !== 'No disponible') {
                navigator.clipboard.writeText(currentHomeCode).then(() => {
                    showToast('C√≥digo copiado al portapapeles');
                });
            }
        }

        function normalizeCustomerClipboardText(text) {
            const rawText = (text || '').trim();
            if (!rawText) {
                return '';
            }

            const startedWithPlus = rawText.startsWith('+');
            const cleanedText = rawText.replace(/[(),-]/g, '').replace(/\s+/g, '');

            if (!startedWithPlus) {
                return cleanedText;
            }

            const digitsOnly = cleanedText.replace(/\D/g, '');
            if (digitsOnly.startsWith('56') && digitsOnly.length >= 8) {
                return digitsOnly.slice(-8);
            }
            if (digitsOnly.length >= 10) {
                return digitsOnly.slice(-10);
            }
            return digitsOnly;
        }

        const pasteCustomerButton = document.getElementById('paste-customer-btn');
        const customerSearchInput = document.getElementById('customer-search-input');

        if (pasteCustomerButton && customerSearchInput) {
            pasteCustomerButton.addEventListener('click', async function () {
                try {
                    const clipboardText = await navigator.clipboard.readText();
                    const formattedText = normalizeCustomerClipboardText(clipboardText);

                    customerSearchInput.value = formattedText;
                    customerSearchInput.focus();
                } catch (error) {
                    showToast('No se pudo leer el portapapeles', 'danger');
                }
            });
        }

// Al presionar 'c' sin selecci√≥n, copiar la √∫ltima clave activa visible
document.addEventListener('keydown', function(e) {
    if (e.key === 'c' && window.getSelection().toString().length === 0) {
        // Buscar todos los textareas de claves activas
        var actives = document.querySelectorAll('textarea[id]:not([id$="2"])');
        if (actives.length > 0) {
            var lastActive = actives[actives.length - 1];
            var id = lastActive.id;
            if (typeof copyAcc === 'function') {
                copyAcc(id);

            }
        }
    }
});
    </script>
{% endblock extrajs %}
